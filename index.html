<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flood Monitoring Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        html, body {
            margin: 10;
            padding: 10;
        }
        h1,h2{
            color: darkblue;
            text-align: center;
        }
        body {
            font-family: Verdana, sans-serif;
            background-color: #a5e2f7; 
            padding: 20px;
        }
        #container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-top: 20px;
        }

        #chart-container,
        #table-container {
            width: 48%; 
        }

        #chart-container {
            background-color: #8cd7f0; 
            padding: 10px;
            border-radius: 8px;
        }

        #table-container {
            background-color: #8cd7f0; 
            padding: 10px;
            border-radius: 8px;
        }
        #labeling{
            color: rgb(63, 142, 211);
            
        }

        #station-select {
            margin-bottom: 20px;
            border-radius: 5px; /* Rounded corners */
            border: 1px solid #3955d1; 
            padding: 6px; 
            font-size: 16px; 
            width: 80%; 
            box-sizing: border-box; 
            
        }
    </style>
</head>
<body>
    <h1>FLOOD MONITORING TOOL</h1>
    <label for="station-select">Select Station:</label>
    <select id="station-select">
        <option value=" " disabled selected hidden>List of stations</option>
    </select>
    <div id="container">
        <div id="chart-container">
        <h2>Line Graph of the selected station</h2>    
            <canvas id="chart" width="400" height="300"></canvas>
        </div>
        <div id="table-container">
            
            <table id="readings-table">
                <thead id="labeling">
                    <tr>
                        <h2>Associated Table Readings</h2>
                        
                    </tr>
                </thead>
                <tbody id="readings-table-body">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stationSelect = document.getElementById('station-select');
            const chartCanvas = document.getElementById('chart');
            const tableBody = document.getElementById('readings-table-body');
            let chartInstance = null; // Variable to hold the chart instance
        
            const apiUrl = 'http://environment.data.gov.uk/flood-monitoring/id/stations';
        
            // Fetch station data
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    data.items.forEach(station => {
                        const option = document.createElement('option');
                        option.value = station["@id"];
                        option.textContent = station.label;
                        stationSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching stations:', error);
                });
        
            // Function to fetch and display chart
            function displayChart(stationId) {
                const chartUrl = `${stationId}/readings?today`; // query for get today's data
                
                fetch(chartUrl)
                    .then(response => response.json())
                    .then(data => {
                        const readings = data.items.map(item => ({
                            x: new Date(item.dateTime),
                            y: item.value
                        }));
        
                        if (chartInstance) {
                            chartInstance.destroy(); // Destroy existing chart
                        }
                        //Rendering the chart
                        const ctx = chartCanvas.getContext('2d');
        
                        chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [{
                                    label: 'Station readings over the last 24 hours',
                                    data: readings,
                                    borderWidth: 1,
                                    tension: 0.5
                                }]
                            },
                            options: {
                                scales: {
                                    x: {
                                        type: 'time',
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Time ->'
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Reading ->'
                                        }
                                    }
                                }
                            }
                        });
        
                        // Populate table with readings data
                        tableBody.innerHTML = '';
                        readings.forEach(reading => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${reading.x.toLocaleString()}</td>
                                <td>${reading.y}</td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching chart data:', error);
                    });
            }
        
            // Event listener for station selection change
            stationSelect.addEventListener('change', (event) => {
                const selectedStationId = event.target.value;
                if (selectedStationId) {
                    displayChart(selectedStationId);
                }
            });
        });
        
    </script>
</body>
</html>
